function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xhr_get(e){var t=new XMLHttpRequest;t.open("GET",e.url,!0),t.onload=function(){200==t.status?e.success&&e.success(t.response):401==t.status&&e.onunauthorized&&e.unauthorized()},e.onerror&&(t.error=function(){e.onerror()}),t.send()}function createFragmentFromTemplate(e){var t=document.createDocumentFragment(),r=document.createElement("body");r.innerHTML=e;for(var n=void 0;n=r.firstElementChild;)t.appendChild(n);return t}function isRegistered(e){return document.createElement(e).constructor!==HTMLElement}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.substring(1)},DocumentFragment.prototype.select=function(e){return"#"==e.charAt(0)?this.getElementById(e.substring(1)):"."==e.charAt(0)?this.getElementsByClassName(e.substring(1))[0]:this.querySelector(e)},DocumentFragment.prototype.selectAll=function(e){return this.querySelectorAll(e)},DocumentFragment.prototype.add=function(e){var t=document.createElement(e.elementType);if(e.innerHTML&&(t.innerHTML=e.innerHTML),e.attributes)for(var r in e.attributes)t.setAttribute(r,e.attributes[r]);return e.insertBefore?(this.insertBefore(t,e.insertBefore),t):(this.appendChild(t),t)},Element.prototype.add=DocumentFragment.prototype.add,DocumentFragment.prototype.importTemplate=function(e){var t=document.createElement("body");e?t.innerHTML=App.htmlTemplates.get(e):t.innerHTML=App.htmlTemplates.get(App.router.currentPage);for(var r=void 0;r=t.firstElementChild;)this.appendChild(r)},Element.prototype.importTemplate=DocumentFragment.prototype.importTemplate;var Router=function(){function e(){_classCallCheck(this,e),this.siteName=window.location.hostname+":"+window.location.port,this.defaultUrlLength=this.siteName.length+window.location.protocol.length+2,this.currentURL=this.siteName+window.location.pathname,this.routes=new Map,this.resourcesForPage=new Map,this.Pages=new Map,this.resourcePaths=new Map,this.availableResources=new Set,this.needAuthentication=new Set,this.navigation=new Map,this.appTitle=AppConfig.title?AppConfig.title:"";var t=!0,r=!1,n=void 0;try{for(var a,o=AppConfig.resources[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var i=a.value;this.resourcePaths.set(i.name,i.path)}}catch(s){r=!0,n=s}finally{try{!t&&o["return"]&&o["return"]()}finally{if(r)throw n}}var u=!0,l=!1,c=void 0;try{for(var h,p=AppConfig.routes[Symbol.iterator]();!(u=(h=p.next()).done);u=!0){var d=h.value;if(d.path.constructor===Array){var m=!0,f=!1,g=void 0;try{for(var v,y=d.path[Symbol.iterator]();!(m=(v=y.next()).done);m=!0){var A=v.value;this.routes.set(A,d.page)}}catch(s){f=!0,g=s}finally{try{!m&&y["return"]&&y["return"]()}finally{if(f)throw g}}}else this.routes.set(d.path,d.page);if(d.navigation&&(d.path.constructor===Array?this.navigation.set(d.path[0],d.navigation):this.navigation.set(d.path,d.navigation)),d.resources){var w=new Map,P=!0,b=!1,T=void 0;try{for(var C,E=d.resources[Symbol.iterator]();!(P=(C=E.next()).done);P=!0){var L=C.value;w.set(L,this.resourcePaths.get(L))}}catch(s){b=!0,T=s}finally{try{!P&&E["return"]&&E["return"]()}finally{if(b)throw T}}this.resourcesForPage.set(d.page,w)}d.auth&&this.needAuthentication.add(d.path)}}catch(s){l=!0,c=s}finally{try{!u&&p["return"]&&p["return"]()}finally{if(l)throw c}}}return _createClass(e,[{key:"navigate",value:function(e,t){t?this.currentURL+=e:this.currentURL=this.siteName+e,window.history.pushState(null,null,"http://"+this.currentURL),this.servePage()}},{key:"servePage",value:function(){this.urlParams=location.pathname.substring(1).split("/");var e=("/"+this.urlParams.shift()).split("="),t=e[0];return e[1]&&this.urlParams.unshift(e[1]),this.routes.has(t)?(this.currentPage=this.routes.get(t),document.getElementsByTagName("main-navigation")[0].setAttribute("active",this.currentPage),void(this.needAuthentication.has(t)?App.userName?this.Pages.has(this.currentPage)?this.showPage():this.loadPage(!0):(this.detachedHandler(),this.showError("unauthorized")):this.Pages.has(this.currentPage)?this.showPage():this.loadPage(!1))):(this.detachedHandler(),void this.showError("pageNotFound"))}},{key:"showError",value:function(e){var t=document.getElementsByTagName("main")[0],r=document.getElementsByTagName("title")[0];r.innerHTML=this.appTitle+"Error","unauthorized"===e?(t.innerHTML="<p>This page is available only to logged in users.</p>",r.innerHTML+="Unauthorized access"):"timeout"===e?(t.innerHTML="<p>We can't load this page. Server timeout.</p>",r.innerHTML+="Server timeout"):"pageNotFound"===e&&(t.innerHTML="<p>Page does not exist.</p>",r.innerHTML+="Page not found")}},{key:"showPage",value:function(){var e=this.Pages.get(this.currentPage),t=this.urlParams,r=document.getElementsByTagName("main")[0];for(e.title&&(document.getElementsByTagName("title")[0].innerHTML=this.appTitle+e.title),this.detachedHandler(e.detachedCallback);r.lastChild;)r.removeChild(r.lastChild);if(e.beforeAttachedCallback&&e.beforeAttachedCallback(t),e.css){var n=document.createElement("style");n.innerHTML=e.css,r.appendChild(n)}r.appendChild(e.init(t)),e.afterAttachedCallback&&e.afterAttachedCallback(t)}},{key:"detachedHandler",value:function(e){this.detachedCallback&&this.detachedCallback(this.previousPageUrlParams),e?(this.detachedCallback=e,this.previousPageUrlParams=this.urlParams):(this.detachedCallback=null,this.previousPageUrlParams=[])}},{key:"loadPage",value:function(e){var t=new Map;if(this.resourcesForPage.has(this.currentPage)){var r=!0,n=!1,a=void 0;try{for(var o,i=this.resourcesForPage.get(this.currentPage)[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;this.availableResources.has(s[0])||(s[1].includes("components")?isRegistered(s[1].substring(s[1].lastIndexOf("/")+1,s[1].lastIndexOf(".")))||t.set(s[0],s[1]):t.set(s[0],s[1]))}}catch(u){n=!0,a=u}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw a}}}t.set("#","/Frontend/pages/"+this.currentPage+".js");e?App.resourceLoader.loadRestrictedScript(t,function(){t["delete"]("#");var e=!0,r=!1,n=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var i=a.value;App.router.availableResources.add(i[0])}}catch(s){r=!0,n=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(r)throw n}}App.router.showPage()},function(){App.router.showError("unauthorized")},function(){App.router.showError("timeout")}):App.resourceLoader.loadScript(t,function(){t["delete"]("#");var e=!0,r=!1,n=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var i=a.value;App.router.availableResources.add(i[0])}}catch(s){r=!0,n=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(r)throw n}}App.router.showPage()},function(){App.router.showError("timeout")})}}]),e}(),ResourceLoader=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"loadScript",value:function(e,t,r){var n=e.size,a=document.getElementsByTagName("head")[0],o=!0,i=!1,s=void 0;try{for(var u,l=function(){var e=u.value;if(e[1].endsWith(".js")){var o=document.createElement("script");o.src=e[1],o.async=!0,o.onload=function(){n-=1,0==n&&t&&t()},o.onerror=function(){r&&r()},a.appendChild(o)}else e[1].endsWith(".html")&&xhr_get({url:e[1],success:function(r){App.htmlTemplates.set(e[0],r),n-=1,0==n&&t&&t()},error:function(){r&&r()}})},c=e[Symbol.iterator]();!(o=(u=c.next()).done);o=!0)l()}catch(h){i=!0,s=h}finally{try{!o&&c["return"]&&c["return"]()}finally{if(i)throw s}}}},{key:"loadRestrictedScript",value:function(e,t,r,n){var a=e.size,o=document.getElementsByTagName("head")[0],i=!0,s=!1,u=void 0;try{for(var l,c=function(){var e=l.value;e[1].endsWith(".js")?!function(){var n=new XMLHttpRequest;n.open("GET",e[1],!0),n.setRequestHeader("Authorization","Bearer "+sessionStorage.token),n.onload=function(){if(-1!=a)if(200==n.status){a-=1;var e=document.createElement("script");e.innerHTML=this.response,o.appendChild(e),0==a&&t&&t()}else 401==n.status&&(a=-1,r())},n.onerror=function(){errorCallback()},n.send()}():e[1].endsWith(".html")&&xhr_get({url:resourcePath,success:function(r){App.htmlTemplates.set(e[0],r),a-=1,0==a&&t&&t()},error:function(){n&&n()}})},h=e[Symbol.iterator]();!(i=(l=h.next()).done);i=!0)c()}catch(p){s=!0,u=p}finally{try{!i&&h["return"]&&h["return"]()}finally{if(s)throw u}}}}]),e}(),Authenticator=function(){function e(){_classCallCheck(this,e),App.userName=sessionStorage.getItem("userName"),App.token=sessionStorage.getItem("token")}return _createClass(e,[{key:"loginRequest",value:function(e,t,r,n,a){var o=new XMLHttpRequest;o.open("POST",r,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var i=encodeURI("login="+e+"&password="+t);o.onload=function(){200==o.status?n(o.response):a()},o.onerror=function(){a()},o.send(i)}}]),e}(),App={htmlTemplates:new Map,init:function(){App.router||(App.router=new Router,App.resourceLoader=new ResourceLoader,App.authenticator=new Authenticator),App.router.servePage()},navigate:function(e,t){function r(e){for(var t=!0;t;){var r=e;if(t=!1,r.href)return r.href.substring(App.router.defaultUrlLength);if(!r.parentElement)return"404";e=r.parentElement,t=!0}}e.preventDefault();var n=void 0;n=r(e.target),"404"===n&&App.router.showError("pageNotFound"),t?App.router.navigate(n,!0):App.router.navigate(n)},login:function(e){var t=App;App.authenticator.loginRequest(e.login,e.password,"/login",function(r){r=r.split(",");var n=r[0],a=r[1];t.userName=n,t.token=a,sessionStorage.setItem("userName",n),sessionStorage.setItem("token",a),e.success(),t.router.servePage(),document.getElementsByTagName("main-navigation")[0].setAttribute("mode","auth")},e.error)},logout:function(){sessionStorage.removeItem("token"),sessionStorage.removeItem("userName"),App.userName=null,App.token=null,document.getElementsByTagName("main-navigation")[0].setAttribute("mode","free"),App.router.servePage()},newPage:function(e){App.router.Pages.set(App.router.currentPage,e)}};App.init(),window.addEventListener("popstate",App.init);
